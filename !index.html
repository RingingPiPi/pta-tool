<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PTA åˆåŒç”Ÿæˆå™¨ V40.2</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #F5F5F5; margin: 0; padding: 15px; color: #333; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h1 { font-size: 20px; color: #1A73E8; margin: 0 0 10px 0; text-align: center; }
        h2 { font-size: 16px; margin: 0 0 10px 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #666; }
        textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; font-size: 14px; box-sizing: border-box; outline: none; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        button { width: 100%; background-color: #1A73E8; color: white; border: none; padding: 12px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:active { background-color: #1557B0; transform: scale(0.98); }
        .btn-green { background-color: #34A853; }
        .status { font-size: 12px; color: #888; text-align: center; margin-top: 10px; }
        .tag { background: #E8F0FE; color: #1A73E8; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <h1>PTA åˆåŒç”Ÿæˆå™¨ <span class="tag">V40.2 PWA</span></h1>

    <div class="card">
        <h2>1. é€‰æ‹©æ¨¡æ¿</h2>
        <input type="file" id="templateFile" accept=".xlsx" />
        <div style="margin-top:5px; font-size:12px; color:#999;">è¯·é€‰æ‹©æ‰‹æœº/ç”µè„‘ä¸­çš„ Excel æ¨¡æ¿æ–‡ä»¶</div>
    </div>

    <div class="card">
        <h2>2. ç²˜è´´æ˜ç»†</h2>
        <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´å¾®ä¿¡æˆäº¤æ˜ç»†..."></textarea>
    </div>

    <div class="card">
        <h2>3. è¡¥å……ä¿¡æ¯</h2>
        <div class="row">
            <div class="col">
                <label>ä¸»åŠ›åˆçº¦</label>
                <input type="text" id="contractCode" placeholder="è‡ªåŠ¨æ¨ç®—">
            </div>
            <div class="col">
                <label>æ˜¨æ—¥ç»“ç®—ä»·</label>
                <input type="text" id="settlePrice" placeholder="è‡ªåŠ¨/æ‰‹åŠ¨">
            </div>
        </div>
        <button class="btn-green" onclick="fetchPrice()">ğŸ“ˆ è·å–è¡Œæƒ… (æ–°æµª)</button>
    </div>

    <button onclick="generate()">ğŸš€ ç”Ÿæˆå¹¶ä¸‹è½½åˆåŒ</button>
    <div class="status" id="statusMsg">å‡†å¤‡å°±ç»ª</div>

<script>
    // æ³¨å†Œ Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('SW Registered'))
            .catch(err => console.log('SW Error:', err));
    }

    // åˆå§‹åŒ–ï¼šæ¨ç®—ä¸»åŠ›åˆçº¦
    window.onload = function() {
        document.getElementById('contractCode').value = calculateMainContract();
    }

    // --- æ ¸å¿ƒé€»è¾‘ (JS å¤åˆ»ç‰ˆ) ---

    function calculateMainContract() {
        const now = new Date();
        const m = now.getMonth() + 1; // 0-11 -> 1-12
        const d = now.getDate();
        const y = now.getFullYear();
        let targetY = y;
        let suffix = "01";

        // 12/15 - 4/14 -> 05
        if ((m === 12 && d >= 15) || (m >= 1 && m <= 3) || (m === 4 && d < 15)) {
            targetY = m === 12 ? y + 1 : y;
            suffix = "05";
        } 
        // 4/15 - 8/14 -> 09
        else if ((m === 4 && d >= 15) || (m >= 5 && m <= 7) || (m === 8 && d < 15)) {
            suffix = "09";
        } 
        // 8/15 - 12/14 -> 01
        else {
            targetY = y + 1;
            suffix = "01";
        }
        return `TA${String(targetY).slice(-2)}${suffix}`;
    }

    // è·¨åŸŸè·å–æ–°æµªè¡Œæƒ… (åˆ©ç”¨ JSONP åŸç†åŠ¨æ€æ³¨å…¥ Script)
    function fetchPrice() {
        const code = document.getElementById('contractCode').value.toUpperCase();
        if (!code) return alert("è¯·å…ˆå¡«å†™åˆçº¦ä»£ç ");

        const script = document.createElement('script');
        // ä½¿ç”¨ https åè®®ï¼Œå°è¯• nf_ å‰ç¼€
        script.src = `https://hq.sinajs.cn/list=nf_${code}`;
        
        script.onload = () => {
            // æ–°æµªè¿”å› var hq_str_nf_TA2605 = "..."
            const varName = `hq_str_nf_${code}`;
            if (window[varName]) {
                const parts = window[varName].split(',');
                // Index 10 æ˜¯æ˜¨ç»“ (å›½å†…æœŸè´§)
                if (parts.length > 10) {
                    document.getElementById('settlePrice').value = parts[10]; // æ˜¨ç»“
                    document.getElementById('statusMsg').innerText = `âœ… è·å–æˆåŠŸ: æ˜¨ç»“ ${parts[10]}, æœ€æ–° ${parts[8]}`;
                } else {
                    alert("æ•°æ®æ ¼å¼è§£æå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™ã€‚");
                }
            } else {
                alert("æœªè·å–åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥ä»£ç æˆ–ç½‘ç»œã€‚");
            }
            document.body.removeChild(script);
        };
        script.onerror = () => {
            alert("è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ã€‚");
            document.body.removeChild(script);
        };
        document.body.appendChild(script);
    }

    function parseText(text) {
        const data = {};
        const lines = text.trim().split('\n');
        
        const find = (regex) => (text.match(regex) || [])[1] || "";
        
        data.buyer = find(/éœ€æ–¹[ï¼š:]\s*(.*)/).trim();
        data.seller = find(/ä¾›æ–¹[ï¼š:]\s*(.*)/).trim();
        
        // åºå·è½¬åç¼€
        const firstChar = text.trim().charAt(0);
        const map = {'1':'A','ä¸€':'A','2':'B','äºŒ':'B','3':'C','ä¸‰':'C'};
        data.suffix = map[firstChar] || 'A';

        // æ—¥æœŸ
        const now = new Date();
        const dateMatch = lines[0].match(/(\d{1,2})[/-](\d{1,2})/);
        let tradeDate = new Date();
        if (dateMatch) {
            tradeDate.setMonth(parseInt(dateMatch[1]) - 1);
            tradeDate.setDate(parseInt(dateMatch[2]));
            // è·¨å¹´ä¿®æ­£
            if (now.getMonth() === 0 && tradeDate.getMonth() === 11) {
                tradeDate.setFullYear(now.getFullYear() - 1);
            }
        }
        
        data.year = String(tradeDate.getFullYear());
        const mm = String(tradeDate.getMonth()+1).padStart(2,'0');
        const dd = String(tradeDate.getDate()).padStart(2,'0');
        data.dateCode = `${mm}${dd}`;
        data.fullDate = `${data.year}å¹´${mm}æœˆ${dd}æ—¥`;
        data.dateSuffix = `${data.dateCode}${data.suffix}`; // å¼ºåŠ›ç»„åˆå˜é‡

        // ä¿è¯é‡‘
        const marginRaw = find(/ä¿è¯é‡‘[ï¼š:]\s*(.*)/);
        let marginDate = "";
        const mMatch = marginRaw.match(/(\d{1,2})[æœˆ/-](\d{1,2})/);
        if (mMatch) {
            let mYear = tradeDate.getFullYear();
            if (tradeDate.getMonth() === 11 && parseInt(mMatch[1]) === 1) mYear++;
            marginDate = `${mYear}å¹´${mMatch[1]}æœˆ${mMatch[2]}æ—¥`;
        }
        data.margin = marginRaw;
        data.marginDate = marginDate;

        // åœ°ç‚¹
        let loc = find(/(?:äº¤å‰²ç å¤´|äº¤å‰²åœ°ç‚¹|äº¤å‰²åœ°)[ï¼š:]\s*(.*)/).trim();
        let cleanLoc = loc.replace(/^éœ€æ–¹|^ä¾›æ–¹/, "").trim();
        if (cleanLoc && !cleanLoc.includes("è‡ªæ") && !cleanLoc.includes("é€åˆ°")) cleanLoc += "è‡ªæ";
        data.location = cleanLoc;

        // ä»·æ ¼ä¸åŸºå·®
        const priceStr = find(/(?:å•ä»·|æš‚å®šå•ä»·)[ï¼š:]\s*(.*)/);
        let price = parseFloat(priceStr.match(/[-+]?\d*\.\d+|\d+/) || 0);
        data.price = price;

        const basisStr = find(/åŸºå·®[ï¼š:]\s*(.*)/).toUpperCase();
        data.isPost = !!basisStr;
        data.basis = basisStr;

        // V40.2 å“ç‰Œé€»è¾‘
        let rawBrand = find(/å“ç‰Œ[ï¼š:]\s*(.*)/).trim();
        let cleanBrand = rawBrand.replace(/\/ä¸€ç­‰å“|ä¸€ç­‰å“|\/ä¼˜ç­‰å“|ä¼˜ç­‰å“/g, "").replace(/[\(ï¼ˆ].*?[\)ï¼‰]/g, "").trim();
        let grade = "ä¼˜ç­‰å“";
        if (cleanBrand.includes("å¨è”") || cleanBrand.includes("å¨å»‰")) {
            cleanBrand = "å¨è”åŒ–å­¦";
            grade = "ä¸€ç­‰å“";
        }
        // ä¿ç•™åŸæ‹¬å·å†…å®¹
        let bracket = rawBrand.match(/[\(ï¼ˆ](.*?)[\)ï¼‰]/);
        if (bracket) grade = `(${bracket[1]})`;
        else grade = `(${grade})`;
        
        data.brand = cleanBrand;
        data.grade = `\n${grade}`; // å¼ºåˆ¶æ¢è¡Œ
        data.brandFull = `${cleanBrand}\n${grade}`;

        // åˆçº¦ä»£ç  (ä¼˜å…ˆç”¨UIå¡«çš„ï¼Œå…¶æ¬¡æ¨ç®—)
        data.contract = document.getElementById('contractCode').value || getContractCode(tradeDate);
        
        // æ˜¨ç»“
        data.settle = document.getElementById('settlePrice').value || (data.isPost ? "ã€è¯·è¡¥å……ã€‘" : "");

        // æ™ºèƒ½åŸºå·®æè¿°
        if (data.isPost) {
            let basisNum = basisStr.match(/[-+]\d+/);
            if (basisNum) {
                let txt = basisNum[0].startsWith('-') ? `å‡${basisNum[0].slice(1)}` : `åŠ ${basisNum[0].slice(1)}`;
                data.basisDesc = txt;
                data.basisVal = basisNum[0].replace('+', '');
            } else {
                 data.basisDesc = `åŠ ${basisStr}`; // å…œåº•
                 data.basisVal = basisStr;
            }
        }

        return data;
    }

    async function generate() {
        const fileInput = document.getElementById('templateFile');
        const text = document.getElementById('inputText').value;

        if (fileInput.files.length === 0) return alert("âŒ è¯·å…ˆé€‰æ‹©æ¨¡æ¿ï¼");
        if (!text) return alert("âŒ è¯·å…ˆç²˜è´´æˆäº¤æ˜ç»†ï¼");

        const btn = document.querySelector('button[onclick="generate()"]');
        btn.innerText = "â³ å¤„ç†ä¸­...";
        btn.disabled = true;

        try {
            const data = parseText(text);
            
            // å®¡æ ¸é€»è¾‘
            const errors = [];
            if (!data.buyer) errors.push("æœªè¯†åˆ«åˆ°ã€éœ€æ–¹ã€‘");
            if (data.price <= 0) errors.push("ä»·æ ¼å¼‚å¸¸");
            if (data.isPost && !data.basis) errors.push("åç‚¹ä»·ç¼ºå¤±åŸºå·®");
            
            if (errors.length > 0) {
                if(!confirm(`âš ï¸ æ£€æµ‹åˆ°ä»¥ä¸‹é—®é¢˜ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ\n\n${errors.join('\n')}`)) {
                    btn.innerText = "ğŸš€ ç”Ÿæˆå¹¶ä¸‹è½½åˆåŒ";
                    btn.disabled = false;
                    return;
                }
            }

            // è¯»å– Excel
            const workbook = new ExcelJS.Workbook();
            const buffer = await fileInput.files[0].arrayBuffer();
            await workbook.xlsx.load(buffer);
            
            const ws = workbook.worksheets[0];
            
            // å¡«å……é€»è¾‘ (å¤åˆ» Python æ ¸å¿ƒ)
            ws.eachRow((row) => {
                row.eachCell((cell) => {
                    if (cell.value && typeof cell.value === 'string') {
                        let val = cell.value;
                        let changed = false;
                        
                        const map = {
                            '{{éœ€æ–¹}}': data.buyer,
                            '{{ä¾›æ–¹}}': data.seller,
                            '{{æš‚å®šå•ä»·}}': data.price,
                            '{{æœ€ç»ˆå•ä»·}}': data.price,
                            '{{åŸºå‡†ä»·}}': data.price, // ä¸€å£ä»·ç”¨
                            '{{åŸºå·®}}': data.basisVal,
                            '{{åŸºå·®æè¿°}}': data.basisDesc,
                            '{{åˆçº¦ä»£ç }}': data.contract,
                            '{{å“ç‰Œ}}': data.brand,
                            '{{ç­‰çº§}}': data.grade,
                            '{{å“ç‰Œå®Œæ•´}}': data.brandFull,
                            '{{æ˜¨ç»“}}': data.settle,
                            '{{æ—¥æœŸä»£ç }}': data.dateCode,
                            '{{åç¼€}}': data.suffix,
                            '{{æ—¥æœŸ+åç¼€}}': data.dateSuffix,
                            '{{ç­¾è®¢æ—¥æœŸ}}': data.fullDate,
                            '{{å¹´ä»½}}': data.year,
                            '{{äº¤å‰²ç å¤´}}': data.location,
                            '{{ä¿è¯é‡‘}}': data.margin,
                            '{{ä¿è¯é‡‘æ—¥æœŸ}}': data.marginDate
                        };

                        for (let key in map) {
                            if (val.includes(key)) {
                                val = val.replace(key, map[key] || "");
                                changed = true;
                            }
                        }

                        if (changed) {
                            cell.value = val;
                            // æ ‡çº¢ + é™¤é»„
                            cell.font = Object.assign({}, cell.font, { color: { argb: 'FFFF0000' } });
                            cell.fill = { type: 'pattern', pattern: 'none' }; 
                            // å¼ºåˆ¶æ¢è¡Œ
                            if (String(val).includes('\n')) {
                                cell.alignment = Object.assign({}, cell.alignment, { wrapText: true });
                            }
                        }
                    }
                });
            });

            // å¯¼å‡º
            const outBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            const fileName = `${data.seller}-${data.buyer} ${data.dateCode}${data.suffix}.xlsx`;
            saveAs(blob, fileName);
            
            document.getElementById('statusMsg').innerText = `âœ… å·²ç”Ÿæˆ: ${fileName}`;

        } catch (err) {
            alert("ç”Ÿæˆå¤±è´¥: " + err.message);
        } finally {
            btn.innerText = "ğŸš€ ç”Ÿæˆå¹¶ä¸‹è½½åˆåŒ";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>